{% extends "base.html" %}

{% block estilscss %}
.item input {
width: 70px;
}
.total , .totalinc {
width: 7em;
text-align: center;
}
.totalbox {
display: inline-block;
}
@media (max-device-width: 650px) , (max-width: 650px) {
.item {
width: 100%;
}
.item select {
width: 100%;
}
.item input , .item subtotal {
//width: 49%;
}
}

.parell {
background-color: #ccc;
}
.parell , .senar {
display:flex;
}
.prod {
flex-grow: 2;
}
.parell input , .senar input {
/*float: right;*/
width: 70px;
}

.ui-accordion .ui-accordion-header {
background-color: #86A328;
border-color: #86A328;
}

/* Basket */
.products { display: flex }
.products-list { width: 50%; padding: 5px }
.products-basket { width: 50%; padding: 5px }
.products h2 { text-align: center }
#products-basket { margin-top: 27px; }
{% endblock %}


{% block headextra %}
{% load static %}
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="/resources/demos/style.css">
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="{% static 'basket.js' %}"></script>
<script type="text/javascript">
  $(function () {
    $(".accordion").accordion({
      heightStyle: "content"
    });
  });
  var products = {{products_by_id_json | safe}};
  $(() => {
    const basket = new Basket({products: products, updateTotals: calcula_tot});
    basket.init();
  });
</script>

<style>
  .ui-accordion .ui-accordion-content {
    padding: 0;
  }
</style>
{% endblock %}


{% block contingut %}

<div class="pissarra">
  <div class="pissarratitol">La Pissarra</div>
  <br>
  {% if avisos %}
  {% for avis in avisos %}
  <div class="avis">
    <h3>{{ avis.titol }}</h3>
    <p>{{ avis.text | linebreaks }}</p>
  </div>
  {% endfor %}
  {% endif %}
</div>

<h2>Comanda</h2>
<div class="totalbox">Total aproximat: <input type="text" class="total" disabled /></div>
<div class="totalbox">Total amb increment: <input type="text" class="totalinc" disabled /></div>

<div class="products">
  <div id="products-list">
    <form method="post" id="comanda">{% csrf_token %}
      {% if form %}
      {{ form.as_p }}
      {% endif %}
      <b style="background-color:yellow;">{{form.cleaned_data.data_recollida}}</b>
      <input type="submit" value="Envia" /> <br>

      <div class="accordion">
        {% for aprod in aproductes %}
        {% ifchanged aprod.activa_proveidor %}
        {% if forloop.first %}
        <h3>{{aprod.producte.proveidor.nom}}</h3>
        <div>
          {% else %}
        </div>
        <h3>{{aprod.producte.proveidor.nom}}</h3>
        <div>
          {% endif %}
          {% endifchanged %}
          <div id="producte-{{aprod.producte.id}}" class="product {% cycle 'senar' 'parell' %}">
            <div class="prod">{{aprod.producte.nom}}</div>
            <input class="price" name="preu-{{aprod.producte.id}}" value="{{aprod.producte.preu}}" disabled>
            {% if aprod.producte.granel %}
            <input class="quantity" name="quantitat-{{aprod.producte.id}}" type="number" value="{{aprod.quantitat}}"
              step="any" />
            {% else %}
            <input class="quantity" name="quantitat-{{aprod.producte.id}}" type="number" value="{{aprod.quantitat}}"
              step="any" />
            {% endif %}

          </div>
          {% endfor %}
        </div>
      </div>
      <input style="align:center" type="submit" value="Envia" />
    </form>
  </div>

  <div id="products-basket" class="accordion">
    <h3>Llista de la compra</h3>
    <div id="basket-list"></div>
  </div>
</div>

<!-- precalcul total -->
<div class="totalbox">Total aproximat: <input type="text" class="total" disabled /></div>
<div class="totalbox">Total amb increment: <input type="text" class="totalinc" disabled /></div>

{% endblock %}


{% block custom_scripts %}
/*
* Scripts per calcular total aproximat i subtotals
*/
{% load l10n %}

var total
function calcula_tot() {
total = 0.0

var qelems = $("#products-list [name^=quantitat]");

qelems.each(function(index) {
var quant = parseFloat( $(this).val() );
var prod_id = $(this).attr("name").split("-")[1];
var preustr = document.getElementsByName("preu-"+prod_id)[0].value;
var preu = parseFloat(preustr.replace(",","."));

if( quant ) {
total += preu * quant;
//console.log( prod_id+" "+preu );
}
})

$('.total').val( total.toFixed(2) +" €")
$('.totalinc').val( Math.round(100*total.toFixed(2)*(1+({{increment|unlocalize}})/100))/100 +" €")
}

calcula_tot()

$('select').change( calcula_tot )
$('input').change( calcula_tot )
$(document).on("change", "#products-list select, input", calcula_tot)

{% endblock %}
